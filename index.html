<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.8.dev">
<meta name="author" content="Manuel Torres - Departamento de Informática. Universidad de Almería">
<title>Creación de una API REST para MongoDB con NestJS</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Creación de una API REST para MongoDB con NestJS</h1>
<div class="details">
<span id="author" class="author">Manuel Torres - Departamento de Informática. Universidad de Almería</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducción">1. Introducción</a></li>
<li><a href="#truepreparación-del-proyecto">2. Preparación del proyecto</a></li>
<li><a href="#trueconfiguración-de-app-module-ts">3. Configuración de <code>app.module.ts</code></a></li>
<li><a href="#trueconfiguración-del-módulo-de-libros">4. Configuración del módulo de libros</a>
<ul class="sectlevel2">
<li><a href="#truecreación-del-esquema">4.1. Creación del esquema</a></li>
<li><a href="#trueconfiguración-del-módulo">4.2. Configuración del módulo</a></li>
<li><a href="#truecreación-del-dto">4.3. Creación del DTO</a></li>
<li><a href="#trueimplementación-del-servicio">4.4. Implementación del servicio</a></li>
<li><a href="#truemodificación-del-controlador">4.5. Modificación del controlador</a></li>
<li><a href="#truefiltrado-de-resultados-mediante-parámetros-en-la-url">4.6. Filtrado de resultados mediante parámetros en la URL</a></li>
<li><a href="#trueprueba-de-los-endpoints">4.7. Prueba de los endpoints</a></li>
</ul>
</li>
<li><a href="#trueconfiguración-del-módulo-de-usuarios">5. Configuración del módulo de usuarios</a>
<ul class="sectlevel2">
<li><a href="#truecreación-del-esquema-2">5.1. Creación del esquema</a></li>
<li><a href="#trueconfiguración-del-módulo-2">5.2. Configuración del módulo</a></li>
<li><a href="#truecreación-del-dto-2">5.3. Creación del DTO</a></li>
<li><a href="#trueimplementación-del-servicio-2">5.4. Implementación del servicio</a></li>
<li><a href="#truemodificación-del-controlador-2">5.5. Modificación del controlador</a></li>
<li><a href="#truefiltrado-de-resultados-mediante-parámetros-en-la-url-2">5.6. Filtrado de resultados mediante parámetros en la URL</a></li>
<li><a href="#trueprueba-de-los-endpoints-2">5.7. Prueba de los endpoints</a></li>
</ul>
</li>
<li><a href="#truerechazo-de-peticiones-con-_id-inválido">6. Rechazo de peticiones con <code>_id</code> inválido</a></li>
<li><a href="#trueincorporación-de-comentarios">7. Incorporación de comentarios</a>
<ul class="sectlevel2">
<li><a href="#truecreación-del-esquema-3">7.1. Creación del esquema</a></li>
<li><a href="#trueincorporación-de-los-comentarios-al-esquema-de-los-libros">7.2. Incorporación de los comentarios al esquema de los libros</a></li>
<li><a href="#truecreación-del-dto-3">7.3. Creación del DTO</a></li>
<li><a href="#trueimplementación-del-método-de-creación-de-comentarios">7.4. Implementación del método de creación de comentarios</a></li>
<li><a href="#truemodificación-del-controlador-3">7.5. Modificación del controlador</a></li>
<li><a href="#trueprueba-del-endpoint">7.6. Prueba del endpoint</a></li>
<li><a href="#trueincoporación-de-los-datos-relacionados">7.7. Incoporación de los datos relacionados</a></li>
</ul>
</li>
<li><a href="#trueanexo-i-configuración-de-mongodb-local-con-docker-compose">Anexo I. Configuración de MongoDB local con Docker Compose</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/di.png" alt="di">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB es la base de datos NoSQL más popular debido a su sencillez, velocidad y a su capaciudad de escalado. Su versatilidad y su rapidez hacen que esté cada vez más presente en el desarrollo de aplicaciones de bases de datos, especialmente en aquellas que pueden crecer a escala Internet. En este tutorial veremos cómo crear una API REST NestJS para MongoDB con Mongoose, el ODM de referencia de MongoDB para Node.js.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Entender los conceptos de esquema y modelo en Mongoose.</p>
</li>
<li>
<p>Definir atributos multivaluados en un esquema.</p>
</li>
<li>
<p>Crear esquemas basados en otros esquemas.</p>
</li>
<li>
<p>Aprender a crear referencias entre esquemas diferentes.</p>
</li>
<li>
<p>Aprender a usar las técnicas para la creación de una API REST NestJS para MongoDB con Mongoose.</p>
</li>
<li>
<p>Filtrar datos de una petición mediante el uso de parámetros de consulta en la URL.</p>
</li>
<li>
<p>Introducir el uso de <em>pipes</em> para comprobar la validez de parámetros de entrada de la API.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponible el <a href="https://github.com/ualmtorres/nestjs-mongodb.git">repositorio</a> usado en este tutorial</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducción"><a class="anchor" href="#trueintroducción"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB es una base de datos que almacena documentos JSON y ofrece una gran escalabilidad y flexibilidad. Actualmente, de acuerdo con <a href="https://db-engines.com/en/ranking">DB-Engines Ranking</a>, es la base de datos NoSQL más popular. Su modelo de datos basado en documentos ofrece una forma de trabajar muy sencilla e intuitiva para desarrolladores.</p>
</div>
<div class="paragraph">
<p><a href="https://mongoosejs.com/">Mongoose</a> es un ODM (Object Document Mapper) para Node.js análogo a los ORM (Object Relational Mapper) como Hibernate para Java, Doctrine para PHP o SQLAlchemy para Python. A pesar de que MongoDB es una base de datos sin esquema, Mongoose proporciona una solución basada en esquemas que ofrece un sistema de tipos, validaciones, construcción de consultas y otras características que lo hacen una opción muy interesante para el desarrollo en de una API REST NestJS si la base de datos en MongoDB.</p>
</div>
<div class="paragraph">
<p>En este tutorial veremos cómo crear una API REST en NestJS para un ejemplo sencillo de un catálogo de libros en MongoDB y programado con Mongoose. Aunque el ejemplo es sencillo, introduciremos las cuestiones cotidianas que se suelen presentar al trabajar con MongoDB, como son el tratamiento que hace MongoDB de los atributos multivaluados, el manejo de relaciones <code>1:M</code> como agregados y la referencia a objetos de otras colecciones de documentos.</p>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra el modelo de agregados que usaremos en este tutorial.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/modelo-de-agregados.png" alt="modelo de agregados">
</div>
</div>
<div class="paragraph">
<p>Básicamente guardamos datos de libros, una lista de palabras clave de cada libro y los distintos comentarios que se realizan sobre ellos. Cada comentario es realizado por una persona y guardaremos una serie de datos de cada persona.</p>
</div>
<div class="paragraph">
<p>Con MongoDB no crearemos una colección para cada una de las entidades de dominio que aparecen en la figura (<code>Book</code>, <code>Comment</code> y <code>User</code>) y otra colección para <code>keywords</code> de <code>Book</code> (que aparece como un array de cadenas), lo que haría un total de cuatro colecciones. Si hiciésemos eso estaríamos utilizando implícitamente las técnicas de diseño de bases de datos relacionales en MongoDB. Y el único cambio que estaríamos haciendo es que en lugar de almacenar filas, estaríamos almacenando documentos JSON. Pero esto no es una buena opción porque no estaríamos aprovechando las ventajas que puede aportar MongoDB. Usar MongoDB implica algo más que cambiar los registros por documentos JSON. Implica cambiar la técnica de diseño. En este caso crearíamos una única colección para todo el agregado, que se corresponde con la zona sombreada de la figura. Denominaremos <code>Book</code> a esa colección y en su esquema habrá:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los campos <em>básicos</em> del libro (<code>id, title, genre, description, author, pages, image_url</code>).</p>
</li>
<li>
<p>Un campo para el atributo multivaluado <code>keywords</code>. Se definiría como una array de cadenas (primer cambio respecto al enfoque relacional).</p>
</li>
<li>
<p>Un campo para la lista de comentarios <code>comments</code>. Se definiría como un array de documentos de tipo <code>Comment</code>(segundo cambio respecto al enfoque relacional). En el esquema <code>Comment</code> el campo <code>username</code> será una referencia al esquema de la colección <code>User</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vemos que la relación <code>1:M</code> queda embebida dentro de los libros. En cambio, no incluimos los datos del usuario en cada comentario para no repetir todos los datos de un usuario cada vez que un usuario realice un comentario.</p>
</div>
<div class="paragraph">
<p>Por tanto, para este ejemplo tendremos únicamente dos colecciones: <code>Book</code> y <code>User</code>. Como escenario de aplicación se puede pensar en una página de un catálogo de libros de una tienda online de libros, en la que para cada libro se mostrarán tanto los datos del libro, como sus palabras clave y sus comentarios. Así, cada vez que se recupere un libro se recupera con todos los datos hay que mostrar.</p>
</div>
<div class="paragraph">
<p>Una implementación relacional habría creado 4 tablas (<code>Book</code>,<code>Book-Keywords</code>, <code>Books-Comments</code> y <code>Comment-User</code>). Este enfoque, además de ser más intuitivo, aumenta la velocidad de las consultas ya que se evitan los joins para recuperar las palabras clave y los comentarios de un libro. Pero ahí no queda todo. Dado que los datos relacionados se almacenan juntos, la base de datos puede escalar horizontalmente añadiendo más nodos a un cluster sin penalizar su rendimiento. Así, unos libros estarán en un nodo y otros estarán en otros, pero no habrá penalización en los joins ya que las palabras clave y los comentarios de cada libro están almacenados junto al libro, y se recuperarán juntos.</p>
</div>
<div class="paragraph">
<p>Casos de uso como aplicaciones IoT (p.e. agregando las medidas de los dispositivos, eventos en una cadena de producción, meteorología), Gaming o aplicaciones de streaming (p.e. guardando las últimas posiciones, eventos, reproducciones, posición de reproducción), Vistas simplificadas de los datos más importantes (p.e. datos calculados, colecciones de datos resumidos) y demás, hacen hoy día de MongoDB una solución de almacenamiento a considerar.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truepreparación-del-proyecto"><a class="anchor" href="#truepreparación-del-proyecto"></a>2. Preparación del proyecto</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comenzamos creando el proyecto y aceptamos las opciones predeterminadas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest new nestjs-mongodb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nuestro proyecto tiene dependencias con Mongoose y Swagger OpenAPI. Las instalaremos con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install --save @nestjs/mongoose mongoose
$ npm install --save @nestjs/swagger swagger-ui-express</code></pre>
</div>
</div>
<div class="paragraph">
<p>La configuración de Swagger se realiza en <code>src/main.ts</code> indicando las opciones de presentación en Swagger UI, como el título, descripción y ruta en la que se sirve la documentación de la API.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/main.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">import { NestFactory } from '@nestjs/core';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Configurar títulos de documentación
  const options = new DocumentBuilder() <i class="conum" data-value="1"></i><b>(1)</b>
    .setTitle('MongoDB Book REST API')
    .setDescription('API REST para libros con MongoDB')
    .setVersion('1.0')
    .build();
  const document = SwaggerModule.createDocument(app, options); <i class="conum" data-value="2"></i><b>(2)</b>

  // La ruta en que se sirve la documentación
  SwaggerModule.setup('docs', app, document); <i class="conum" data-value="3"></i><b>(3)</b>

  await app.listen(3000);
}
bootstrap();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creación de la configuración de las opciones de presentación de Swagger</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Preparación de la configuración creada para Swagger</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Aplicación de la configuración y definición de <code>docs</code> como la ruta en la que se sirve la documentación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación generamos con el CLI de NestJS dos <code>resource</code> para libros y usuarios aceptando los valores predeterminados de si queremos crear los recursos para una API REST y que genere los endpoints para CRUD.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ nest generate resource books
$ nest generate resource users</code></pre>
</div>
</div>
<div class="paragraph">
<p>La generación de un <code>resource</code> con el CLI de NestJS genera los archivos de los servicios, controladores, módulos, DTOs y entidades. Además, proporciona una pequeña implementación inicial para cada uno de ellos. En NestJS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Los controladores se encargan de gestionar las peticiones que llegan y devuelven las respuestas al cliente.</p>
</li>
<li>
<p>Los servicios se encargan de resolver las peticiones. En nuestro caso se encargan de la interacción con MongoDB recuperando y almacenando documentos.</p>
</li>
<li>
<p>Los módulos permiten organizar la estructura de la aplicación e incluyen los controladores, servicios y los módulos que a su vez usan.</p>
</li>
<li>
<p>Los DTO definen la estructura de los objetos que se pasan en el cuerpo de las peticiones HTTP.</p>
</li>
<li>
<p>Una entidad representa a una clase que se persiste en la base de datos. <strong>En Mongoose se usa el término <em>esquema</em> en lugar de <em>entidad</em> para hacer referencia a la clase que se persiste en la base de datos.</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ponemos la aplicación en uso con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run start:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al probar el endpoint <code>GET /books</code> en <code>&lt;url&gt;:&lt;port&gt;/books</code> (p.e. <code><a href="http://localhost:3000/books" class="bare">http://localhost:3000/books</a></code>) obtendremos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="code" class="language-code hljs">This action returns all books</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al abrir el navegador en la ruta <code>&lt;url&gt;:&lt;port&gt;/docs</code> (p.e. <code><a href="http://localhost:3000/docs" class="bare">http://localhost:3000/docs</a></code>) vemos Swagger UI mostrando todos los endpoints de la API.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Swagger-inicial.png" alt="Swagger inicial">
</div>
</div>
<div class="paragraph">
<p>Si desplegamos el endpoint <code>GET /books</code>, pulsamos el botón <code>Try it out</code> y luego pulsamos el botón <code>Execute</code> se llamará al endpoint <code>GET /books</code>. En <code>Server response</code> se muestra el código de la respuesta en <code>Code</code> y el resultado en <code>Response body</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/swagger-get-books-inicial.png" alt="swagger get books inicial">
</div>
</div>
<div class="paragraph">
<p>Como podemos comprobar, el uso de <code>nest generate resource</code> del CLI de NestJS nos ayuda enormemente al crear el <em>scaffolding</em> para los objetos del dominio de nuestra aplicación (p.e. <code>books</code> y <code>users</code>). Nos genera una base funcional para las operaciones CRUD con los endpoints HTTP disponibles paras las operaciones <code>GET</code>, <code>POST</code>, <code>PATCH</code> y <code>DELETE</code> y las asocia a sus respectivos métodos en los servicios creados. Como hemos visto al probar <code>GET /books</code>,  la implementación de los servicios se limita a informar que han sido llamados. Posteriormente habrá que implementarlos programando la operación correspondiente de base de datos para cumplir su cometido real. Esta implementación la haremos cuando empecemos a desarrollar los respectivos módulos del dominio (<code>books</code> y <code>users</code>) en secciones posteriores.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advertencia sobre la generación de un <code>resource</code> para Mongoose</div>
<div class="paragraph">
<p>La generación de <code>resource</code> con el CLI de NestJS está ideada para bases de datos relacionales. Esto se aprecia en que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Genera <em>entidades</em>. Las entidades son una abstracción que representa la persistencia en la base de datos de una clase del dominio. El término <em>entidad</em> está asumido en el contexto del uso de ORMs en bases de datos relacionales.</p>
</li>
<li>
<p>Supone que los identificadores que se van a usar en la base de datos son numéricos. Es conocido el uso de enteros autoincrementales para definir claves primarias en tablas de bases de datos relacionales.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sin embargo, cuando trabajamos con Mongoose:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Se usa el término <em>esquema</em> en lugar de <em>entidad</em>.</p>
</li>
<li>
<p>En MongoDB el <code>_id</code> de los documentos de una colección no es de tipo entero, sino que es una cadena hexadecimal de 24 caracteres.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Por tanto, habrá que hacer unas ligeras modificaciones sobre el código generado por el CLI de NestJS para adaptarlo a Mongoose. Estas modificaciones sobre el código generado para un <code>resource</code> son una opción más rápida que la creación y programación manual desde cero de los módulos, controladores, servicios, DTOs y esquemas que necesitaremos para cada objeto del dominio.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconfiguración-de-app-module-ts"><a class="anchor" href="#trueconfiguración-de-app-module-ts"></a>3. Configuración de <code>app.module.ts</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>En <code>app.module.ts</code> se añade la configuración del acceso a MongoDB. Para nuestro ejemplo, MongoDB está en local, se accede a través del puerto <code>27017</code> y no necesita contraseña. Para otras configuraciones (p.e. <em>replica sets</em>, acceso autenticado, y demás, consultar la <a href="https://mongoosejs.com/docs/connections.html#connection-string-options">documentación oficial de Mongoose</a>).</p>
</div>
<div class="paragraph">
<p>En este tutorial prepararemos una conexión local a MongDB creando una base de datos <code>tutorial</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { MongooseModule } from '@nestjs/mongoose';
import { UsersModule } from './users/users.module';
import { BooksModule } from './books/books.module';

@Module({
  imports: [
    MongooseModule.forRoot('mongodb://localhost:27017/tutorial'), <i class="conum" data-value="1"></i><b>(1)</b>
    UsersModule,
    BooksModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Conexión a base de datos <code>tutorial</code> en MongoDB local</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconfiguración-del-módulo-de-libros"><a class="anchor" href="#trueconfiguración-del-módulo-de-libros"></a>4. Configuración del módulo de libros</h2>
<div class="sectionbody">
<div class="paragraph">
<p>De acuerdo con el diagrama de <a href="#trueintroducción">Introducción</a> tenemos objetos de dominio para libros y para los usuarios que realizan los comentarios sobre los libros. En esta sección nos centraremos sólo en los libros, sin incluir aún la relación con los autores de los comentarios. La inclusión de la referencia a los autores la dejamos para la sección <a href="#trueincorporación-de-comentarios">Incorporación de comentarios</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es una buena técnica comenzar desarrollando inicialmente los módulos/clases/bloques de la API correspondiente a las clases del dominio que vamos a persistir en bases de datos. Una vez comprobado su funcionamiento por separado, se introducen las modificaciones en los esquemas Mongoose para incluir las relaciones a otros esquemas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Tal y como hemos comentado en <a href="#trueintroducción">Introducción</a> hay que hacer unos ligeros cambios sobre el código generado para el <code>resource</code> con el CLI de NestJS. En concreto, habrá que cambiar las referencias a entidades por esquemas, y cambiar los identificadores de bases de datos numéricos a cadenas, ya que los <code>_id</code> de MongoDB son cadenas hexadecimales de 24 caracteres.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truecreación-del-esquema"><a class="anchor" href="#truecreación-del-esquema"></a>4.1. Creación del esquema</h3>
<div class="paragraph">
<p>Comenzamos cambiando las entidades generadas por el CLI de NestJS por esquemas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Renombramos la carpeta <code>src/books/entities</code> por <code>src/books/schemas</code></p>
</li>
<li>
<p>Renombramos el archivo <code>src/books/entities/book.entity.ts</code> por <code>src/books/schemas/book.schema.ts</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para definir un esquema Mongoose hay que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir a la clase el decorador <code>@Schema()</code></p>
</li>
<li>
<p>Definir en la clase cada campo de la colección y añadirle el decorador <code>@Prop()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El decorador <code>@Schema()</code> sobre una clase hace que se cree una colección en MongoDB con el nombre de la clase, pero en plural (añadiéndole una <em>"s"</em>). El decorador <code>@Prop()</code> sobre una propiedad de la clase añade a la colección un campo con el nombre de la propiedad.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/schemas/book.schema.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Schema, Prop, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose'; <i class="conum" data-value="1"></i><b>(1)</b>

export type BookDocument = Book &amp; Document; <i class="conum" data-value="2"></i><b>(2)</b>

@Schema() <i class="conum" data-value="3"></i><b>(3)</b>
export class Book {
  @Prop() <i class="conum" data-value="4"></i><b>(4)</b>
  genre: string;

  @Prop()
  description: string;

  @Prop()
  author: string;

  @Prop()
  pages: number;

  @Prop()
  image_url: string;

  @Prop([String]) <i class="conum" data-value="5"></i><b>(5)</b>
  keywords: string[];
}

export const BookSchema = SchemaFactory.createForClass(Book); <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de <code>Document</code> desde Mongoose</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo de un documento libro</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Decorador para crear una colección MongoDB para la clase</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Decorador para añadir un campo a la colección</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Indicación de un tipo no primitivo</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Esquema Mongoose creado a partir de la clase <code>Book</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para tipos no primitivos (como arrays, documentos o una combinación de ellos) hay que añadir en <code>@Prop()</code> el tipo de datos que se va usar.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-del-módulo"><a class="anchor" href="#trueconfiguración-del-módulo"></a>4.2. Configuración del módulo</h3>
<div class="paragraph">
<p>En el módulo tenemos que registrar el esquema para que cree la colección correspondiente en MongoDB. Esto lo haremos añadiendo el método <code>forFeature</code> de <code>MongooseModule</code> en el array <code>imports</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { BooksService } from './books.service';
import { BooksController } from './books.controller';
import { MongooseModule } from '@nestjs/mongoose';
import { Book, BookSchema } from './schemas/book.schema';

@Module({
  imports: [
    MongooseModule.forFeature([{ name: Book.name, schema: BookSchema }]), <i class="conum" data-value="1"></i><b>(1)</b>
  ],
  controllers: [BooksController],
  providers: [BooksService],
})
export class BooksModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Registro del esquema de los libros</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al guardar los cambios, Mongoose crea la colección <code>books</code> en la base de datos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si la base de datos no estaba creada aún, al guardar el primer esquema, se crea la base de datos y la colección asociada al esquema creado.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto"><a class="anchor" href="#truecreación-del-dto"></a>4.3. Creación del DTO</h3>
<div class="paragraph">
<p>El DTO define la estructura de un objeto que se pasa en el cuerpo de una petición HTTP. Inicialmente, y de acuerdo con el diagrama de <a href="#trueintroducción">Introducción</a>, los campos de los libros, excluídos los campos de relación, son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> como identificador del libro.</p>
</li>
<li>
<p><code>title</code> para el título</p>
</li>
<li>
<p><code>genre</code> para el género</p>
</li>
<li>
<p><code>description</code> para una descripción completa</p>
</li>
<li>
<p><code>author</code> para el autor del libro</p>
</li>
<li>
<p><code>pages</code> para el número de páginas</p>
</li>
<li>
<p><code>image_url</code> para la URL en la que está disponible la imagen del libro</p>
</li>
<li>
<p><code>keywords</code> con una lista de palabras clave</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/dto/create-book.dto.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
export class CreateBookDto {
  @ApiProperty({ <i class="conum" data-value="1"></i><b>(1)</b>
    example: 'Nest.js: A Progressive Node.js Framework (English Edition)',
  })
  readonly title: string; <i class="conum" data-value="2"></i><b>(2)</b>

  @ApiProperty({ example: 'Web Development' })
  readonly genre: string;

  @ApiProperty({
    example:
      'JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...',
  })
  readonly description: string;

  @ApiProperty({ example: 'Jay Bell' })
  readonly author: string;

  @ApiProperty({ example: 350 })
  readonly pages: number;

  @ApiProperty({
    example: 'https://m.media-amazon.com/images/I/41fveBeDWmL._SY346_.jpg',
  })
  readonly image_url: string;

  @ApiProperty({ example: ['NestJS', 'REST API'] }) <i class="conum" data-value="3"></i><b>(3)</b>
  readonly keywords: string[];
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para definir una propiedad para la documentación en Swagger OpenAPI</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición de campo</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ejemplo como un array</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En Swagger UI, al desplegar el endpoint <code>POST /books</code> el ejemplo muestra los valores configurados con el decorador <code>@ApiProperty</code> de Swagger OpenAPI. También aparecen como plantilla si probásemos a introducir un libro. Aún no probaremos a insertar el libro porque está sin implementar el servicio. Recordamos que la implementación actual del servicio es la que ha generado el CLI de NestJS y se limita a mostrar que el servicio ha sido llamado. Hay que cambiar su implementación para que interactúe con la base de datos.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/dto-libro.png" alt="dto libro">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-servicio"><a class="anchor" href="#trueimplementación-del-servicio"></a>4.4. Implementación del servicio</h3>
<div class="paragraph">
<p>Partimos del código generado por el CLI de NestJS para el servicio. Además de dar la implementación de la interacción con la base de datos mediante Mongoose habrá que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hacer que los métodos sean <code>async</code> ya que los métodos de acceso a la base de datos son asíncronos y devuelven promesas.</p>
</li>
<li>
<p>Configurar el tipo devuelto por los métodos.</p>
</li>
<li>
<p>Cambiar el parámetro <code>id</code> de <code>number</code> a <code>string</code> para que pueda tratar con el <code>_id</code> hexadecimal de MongoDB.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Recordamos que el CLI de NestJS genera el código de los métodos del servicio pensando en que la clave es de tipo numérico. Hay que cambiar el tipo del argumento <code>id</code> en los métodos <code>findOne</code>, <code>update</code> y <code>remove</code> a <code>string</code> para que sea válido para el <code>_id</code> de 24 caracteres hexadecimales de MongoDB.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Los métodos que usaremos de Mongoose serán</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>create()</code> para la inserción de un documento.</p>
</li>
<li>
<p><code>find()</code> para recuperar todo.</p>
</li>
<li>
<p><code>findOne()</code> para recuperar un documento.</p>
</li>
<li>
<p><code>findOneAndUpdate()</code> para la actualización de un documento.</p>
</li>
<li>
<p><code>remove()</code> para la eliminación de un documento.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { InjectModel } from '@nestjs/mongoose';
import { Book, BookDocument } from './schemas/book.schema';
import { Model } from 'mongoose';

@Injectable()
export class BooksService {
  constructor( <i class="conum" data-value="1"></i><b>(1)</b>
    @InjectModel(Book.name) private readonly bookModel: Model&lt;BookDocument&gt;, <i class="conum" data-value="2"></i><b>(2)</b>
  ) {}

  async create(createBookDto: CreateBookDto): Promise&lt;Book&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
    return this.bookModel.create(createBookDto); <i class="conum" data-value="4"></i><b>(4)</b>
  }

  async findAll(): Promise&lt;Book[]&gt; { <i class="conum" data-value="5"></i><b>(5)</b>
    return this.bookModel.find().exec();
  }

  async findOne(id: string): Promise&lt;Book&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
    return this.bookModel.findOne({ _id: id }).exec(); <i class="conum" data-value="7"></i><b>(7)</b>
  }

  async update(id: string, updateBookDto: UpdateBookDto): Promise&lt;Book&gt; { <i class="conum" data-value="8"></i><b>(8)</b>
    return this.bookModel.findOneAndUpdate({ _id: id }, updateBookDto, { <i class="conum" data-value="9"></i><b>(9)</b>
      new: true, <i class="conum" data-value="10"></i><b>(10)</b>
    });
  }

  async remove(id: string) { <i class="conum" data-value="11"></i><b>(11)</b>
    return this.bookModel.findByIdAndRemove({ _id: id }).exec(); <i class="conum" data-value="12"></i><b>(12)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadir un constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definir un modelo para libros mediante inyección de dependencias</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cambiar a <code>async</code> y que devuelva <code>Promise&lt;Book&gt;</code> con el libro creado</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamada al método de creación de documentos</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Cambiar a <code>async</code> y que devuelva <code>Promise&lt;Book[]&gt;</code> con la lista de libros</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Cambio del tipo <code>id</code> a <code>string</code> para adaptarlo al <code>_id</code> de MongoDB, cambiar a <code>async</code> y que devuelva <code>Promise&lt;Book&gt;</code> con el libro buscado</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Llamada al método de búsqueda de un documento por <code>id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Cambio del tipo <code>id</code> a <code>string</code> para adaptarlo al <code>_id</code> de MongoDB, cambiar a <code>async</code> y que devuelva <code>Promise&lt;Book&gt;</code> con el libro modificado</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Llamada al método de actualización de documentos por <code>id</code> pasándole el JSON con las modificaciones</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Opción para que devuelva el objeto modificado</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Cambio del tipo <code>id</code> a <code>string</code> para adaptarlo al <code>_id</code> de MongoDB y cambiar a <code>async</code></td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Llamada al método de eliminación de documentos por <code>id</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>De forma predeterminada, el método <code>findOneAndUpdate</code> devuelve el objeto original, no el modificado. Para que devuelva el objeto ya modificado hay que pasar al método la opción de <code>{new: true}</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Modelos en Mongoose</div>
<div class="paragraph">
<p>Los modelos en Mongoose son los homólogos de los repositorios en TypeORM.</p>
</div>
<div class="paragraph">
<p>Cuando estamos creando una API en NestJS con una base de datos relacional, en el constructor del servicio se inyecta un objeto <em>repositorio</em> que envuelve a la <em>entidad</em> que se persiste en la base de datos. El objeto <em>repositorio</em> ofrece todos los métodos para interactuar con la base de datos y abstraernos de los detalles (métodos <code>create</code>, <code>find</code>, <code>findOne</code>, <code>save</code>, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>En los servicios con Mongose inyectaremos un objeto <em>modelo</em> que envuelve al <em>esquema</em> que se persiste en MongoDB. El objeto <em>modelo</em> ofrece todos los métodos para interactuar con la base de datos y abstraernos de los detalles (métodos <code>create</code>, <code>find</code>, <code>findOne</code>, <code>save</code>, &#8230;&#8203;).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truemodificación-del-controlador"><a class="anchor" href="#truemodificación-del-controlador"></a>4.5. Modificación del controlador</h3>
<div class="paragraph">
<p>En el controlador hay que hacer pocos cambios respecto al código generado por el CLI de NestJS. Sólo haremos cambios para</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No convertir a <code>number</code> el valor del <code>id</code> recibido como parámetro en la URL para las operaciones de buscar uno, modificar y eliminar.</p>
</li>
<li>
<p>Añadir decoradores de Swagger OpenAPI.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Req } from '@nestjs/common';
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger'; <i class="conum" data-value="1"></i><b>(1)</b>
import { BooksService } from './books.service';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';

@Controller('books')
@ApiTags('book') <i class="conum" data-value="2"></i><b>(2)</b>

export class BooksController {
  constructor(private readonly booksService: BooksService) {}

  @Post()
  create(@Body() createBookDto: CreateBookDto) {
    return this.booksService.create(createBookDto);
  }

  @Get()
  findAll() {
    return this.booksService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.booksService.findOne(id); <i class="conum" data-value="3"></i><b>(3)</b>
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateBookDto: UpdateBookDto) {
    return this.booksService.update(id, updateBookDto); <i class="conum" data-value="4"></i><b>(4)</b>
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.booksService.remove(id); <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador de OpenAPI para agrupar los endpoints en Swagger UI</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Agrupar los endpoints para una etiqueta en Swagger UI</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pasar al servicio el <code>id</code> como cadena porque el <code>_id</code> en MongoDB son cadenas hexadecimales</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pasar al servicio el <code>id</code> como cadena porque el <code>_id</code> en MongoDB son cadenas hexadecimales</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pasar al servicio el <code>id</code> como cadena porque el <code>_id</code> en MongoDB son cadenas hexadecimales</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La configuración del decorador <code>@ApiTags('book')</code> ha creado una categoría <code>book</code> en Swagger UI para los libros.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/categoria-book.png" alt="categoria book">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truefiltrado-de-resultados-mediante-parámetros-en-la-url"><a class="anchor" href="#truefiltrado-de-resultados-mediante-parámetros-en-la-url"></a>4.6. Filtrado de resultados mediante parámetros en la URL</h3>
<div class="paragraph">
<p>Podemos añadir a nuestras peticiones de recuperación de datos opciones de filtrado. Lo haremos mediante parámetros de consulta en la URL (p.e. <code>?keywords=NestJS&amp;pages=350</code>). Para ello, añadiremos un objeto <code>Request</code> de <code>Express</code> al método <code>findAll</code> para permitir el uso de parámetros en la URL para el filtrado de resultados.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Req } from '@nestjs/common';
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
import { Request } from 'express'; <i class="conum" data-value="1"></i><b>(1)</b>
import { BooksService } from './books.service';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';

@Controller('books')
@ApiTags('book')
export class BooksController {
  constructor(private readonly booksService: BooksService) {}

  @Post()
  create(@Body() createBookDto: CreateBookDto) {
    return this.booksService.create(createBookDto);
  }

  @Get()
  findAll(@Req() request: Request) { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.booksService.findAll(request); <i class="conum" data-value="3"></i><b>(3)</b>
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.booksService.findOne(id);
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateBookDto: UpdateBookDto) {
    return this.booksService.update(id, updateBookDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.booksService.remove(id);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de objetos <code>Request</code> de <code>Express</code> en el controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incluir un parámetro con un objeto <code>Request</code> para acceder a los parámetros de la consulta en la URL</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Incluir el objeto <code>Request</code> en la llamada al servicio</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora introducimos los cambios en el servicio para permitir acceder a los parámetros introducidos en la URL para filtrar y cambiamos la implementación del método <code>findAll</code> para que use la búsqueda con filtros.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { InjectModel } from '@nestjs/mongoose';
import { Book, BookDocument } from './schemas/book.schema';
import { Model } from 'mongoose';
import { Request } from 'express'; <i class="conum" data-value="1"></i><b>(1)</b>

@Injectable()
export class BooksService {
  constructor(
    @InjectModel(Book.name) private readonly bookModel: Model&lt;BookDocument&gt;,
  ) {}

  async create(createBookDto: CreateBookDto): Promise&lt;Book&gt; {
    return this.bookModel.create(createBookDto);
  }

  async findAll(request: Request): Promise&lt;Book[]&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.bookModel
      .find(request.query) <i class="conum" data-value="3"></i><b>(3)</b>
      .setOptions({ sanitizeFilter: true }) <i class="conum" data-value="4"></i><b>(4)</b>
      .exec();
  }

  async findOne(id: string): Promise&lt;Book&gt; {
    return this.bookModel.findOne({ _id: id }).exec();
  }

  async update(id: string, updateBookDto: UpdateBookDto) {
    return this.bookModel.findOneAndUpdate({ _id: id }, updateBookDto, {
      new: true,
    });
  }

  async remove(id: string) {
    return this.bookModel.findByIdAndRemove({ _id: id }).exec();
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadir la dependencia con <code>Request</code> de <code>Express</code> para acceder a los parámetros de la consulta de una <code>request</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Añadir un parámetro <code>Request</code> para acceder a los parámetros de la consulta pasados en la URL</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamada al método de búsqueda de documentos pasándole los parámetros de la consulta</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configuración para evitar la inyección de código malicioso</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>request.query</code> devuelve una lista clave-valor con cada uno de los campos de filtrado y su valor correspondiente introducidos en la URL.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueprueba-de-los-endpoints"><a class="anchor" href="#trueprueba-de-los-endpoints"></a>4.7. Prueba de los endpoints</h3>
<div class="paragraph">
<p>Probamos el endpoint <code>POST /books</code> con los valores del ejemplo</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/book-post.png" alt="book post">
</div>
</div>
<div class="paragraph">
<p>El resultado devuelto será similar a este, en el que se muestran los datos guardados en la base de datos junto al <code>_id</code> generado por MongoDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "genre": "Web Development",
  "description": "JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...",
  "author": "Jay Bell",
  "pages": 350,
  "image_url": "https://m.media-amazon.com/images/I/41fveBeDWmL._SY346_.jpg",
  "keywords": [
    "NestJS",
    "REST API"
  ],
  "_id": "62594f8ddae1eebf6c6c209c",
  "__v": 0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la inserción podemos probar que se recuperan correctamente los libros con el endpoint <code>GET /books</code>. Para probar el endpoint que devuelve un libro concreto, copiaremos el <code>_id</code> del libro, desplegaremos en Swagger UI el endpoint <code>GET /books/{:id}</code>, pulsamemos <code>Try it out</code> para probar el endpoint e introduciremos el <code>_id</code> del libro creado. Tras pulsar <code>Execute</code> vemos que se recupera correctamente el libro.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/book-findone.png" alt="book findone">
</div>
</div>
<div class="paragraph">
<p>Para probar el filtrado comprobaremos con una condición de filtrado para libros con 350 páginas. Para ello, en la URL introduciremos la condición de esta forma</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="code" class="language-code hljs">$ http://localhost:3000/books?pages=350</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para hacer esta prueba necesitaremos un cliente HTTP o bien introducir la URL en un navegador.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/query-params.png" alt="query params">
</div>
</div>
<div class="paragraph">
<p>Podemos concatenar varias condiciones y hará un <code>AND</code> lógico con ellas. Para devolver los libros de 350 páginas del género <code>Web Development</code> usaríamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="code" class="language-code hljs">http://localhost:3000/books?pages=350&amp;genre=Web%20Development</code></pre>
</div>
</div>
<div class="paragraph">
<p>Además, permite la búsqueda en arrays. Para buscar los libros que contengan <code>NestJS</code> en sus palabras clave usaríamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="code" class="language-code hljs">http://localhost:3000/books?keywords=NestJS</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para hacer una modificación se pasará un JSON en el cuerpo de la petición con los cambios a realizar. Por ejemplo, para cambiar el número de páginas a 400 pasaríamos este JSON en el cuerpo de la petición al endpoint <code>PATCH /books/{id}</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "pages": 400
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lanzamos la petición con el <code>_id</code> del libro a modificar, los cambios se almacenarán en la base de datos y nos devolverá los datos actualizados con el número de páginas a 400.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "_id": "62594f8ddae1eebf6c6c209c",
  "genre": "Web Development",
  "description": "JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...",
  "author": "Jay Bell",
  "pages": 400,
  "image_url": "https://m.media-amazon.com/images/I/41fveBeDWmL._SY346_.jpg",
  "keywords": [
    "NestJS",
    "REST API"
  ],
  "__v": 0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para eliminar un libro basta con usar el endpoint <code>DELETE /book/{id}</code> con el <code>_id</code> del libro a eliminar.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconfiguración-del-módulo-de-usuarios"><a class="anchor" href="#trueconfiguración-del-módulo-de-usuarios"></a>5. Configuración del módulo de usuarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>De acuerdo con el diagrama de <a href="#trueintroducción">Introducción</a> tenemos objetos de dominio para libros y para los usuarios que realizan los comentarios sobre los libros. En esta sección nos centraremos en los usuarios.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es una buena técnica comenzar desarrollando inicialmente los módulos/clases/bloques de la API correspondiente a las clases del dominio que vamos a persistir en bases de datos. Una vez comprobado su funcionamiento por separado, se introducen las modificaciones en los esquemas Mongoose para incluir las relaciones a otros esquemas.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Tal y como hemos comentado en <a href="#trueintroducción">Introducción</a> hay que hacer unos ligeros cambios sobre el código generado para el <code>resource</code> con el CLI de NestJS. En concreto, habrá que cambiar las referencias a entidades por esquemas, y cambiar los identificadores de bases de datos numéricos a cadenas, ya que los <code>_id</code> de MongoDB son cadenas hexadecimales de 24 caracteres.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truecreación-del-esquema-2"><a class="anchor" href="#truecreación-del-esquema-2"></a>5.1. Creación del esquema</h3>
<div class="paragraph">
<p>Comenzamos cambiando las entidades generadas por el CLI de NestJS por esquemas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Renombramos la carpeta <code>src/users/entities</code> por <code>src/users/schemas</code></p>
</li>
<li>
<p>Renombramos el archivo <code>src/users/entities/book.entity.ts</code> por <code>src/users/schemas/user.schema.ts</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para definir un esquema Mongoose hay que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir a la clase el decorador <code>@Schema()</code></p>
</li>
<li>
<p>Definir en la clase cada campo de la colección y añadirle el decorador <code>@Prop()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El decorador <code>@Schema()</code> sobre una clase hace que se cree una colección en MongoDB con el nombre de la clase, pero en plural (añadiéndole una <em>"s"</em>). El decorador <code>@Prop()</code> sobre una propiedad de la clase añade a la colección un campo con el nombre de la propiedad.</p>
</div>
<div class="paragraph">
<p>Para el caso de usuarios introduciremos un cambio respecto al ejemplo de libros. Para los usuarios, el <code>_id</code> será gestionado por nosotros y el ´_id` de cada usuario será su login, que es único y también valdrá.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En una colección MongoDB podemos optar por tener nuestros propios identificadores de documentos siempre y cuando controlemos su unicidad. En tal caso, cada vez que se haga una inserción habrá que proporcionar un valor único para <code>_id</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/users/schemas/user.schema.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose'; <i class="conum" data-value="1"></i><b>(1)</b>

export type UserDocument = User &amp; Document; <i class="conum" data-value="2"></i><b>(2)</b>

@Schema() <i class="conum" data-value="3"></i><b>(3)</b>
export class User {
  @Prop() <i class="conum" data-value="4"></i><b>(4)</b>
  _id: string; <i class="conum" data-value="5"></i><b>(5)</b>

  @Prop()
  name: string;

  @Prop()
  email: string;

  @Prop()
  country: string;
}

export const UserSchema = SchemaFactory.createForClass(User); <i class="conum" data-value="6"></i><b>(6)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de <code>Document</code> desde Mongoose</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo de un documento usuario</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Decorador para crear una colección MongoDB para la clase</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Decorador para añadir un campo a la colección</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Gestión propia del <code>_id</code>. Guardaremos el login, y nos aseguraremos de que sea único.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Esquema Mongoose creado a partir de la clase <code>User</code></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-del-módulo-2"><a class="anchor" href="#trueconfiguración-del-módulo-2"></a>5.2. Configuración del módulo</h3>
<div class="paragraph">
<p>Tal y como hemos comentado anteriormente, en el módulo tenemos que registrar el esquema para que cree la colección correspondiente en MongoDB. Esto lo haremos añadiendo el método <code>forFeature</code> de <code>MongooseModule</code> en el array <code>imports</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo 'src/users/users.module.ts'</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { UsersService } from './users.service';
import { UsersController } from './users.controller';
import { MongooseModule } from '@nestjs/mongoose';
import { User, UserSchema } from './schemas/user.schema';

@Module({
  imports: [
    MongooseModule.forFeature([{ name: User.name, schema: UserSchema }]), <i class="conum" data-value="1"></i><b>(1)</b>
  ],
  controllers: [UsersController],
  providers: [UsersService],
})
export class UsersModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Registro del esquema de los usuario</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al guardar los cambios, Mongoose crea la colección <code>users</code> en la base de datos.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si la base de datos no estaba creada aún, al guardar el primer esquema, se crea la base de datos y la colección asociada al esquema creado.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto-2"><a class="anchor" href="#truecreación-del-dto-2"></a>5.3. Creación del DTO</h3>
<div class="paragraph">
<p>Tal y como hemos comentado anteriormente, el DTO define la estructura de un objeto que se pasa en el cuerpo de una petición HTTP. Inicialmente, y de acuerdo con el diagrama de <a href="#trueintroducción">Introducción</a>, los campos de los usuarios son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> como identificador del usuario.</p>
</li>
<li>
<p><code>name</code> para el nombre del usuario</p>
</li>
<li>
<p><code>email</code> para el email</p>
</li>
<li>
<p><code>country</code> para el país del usuario</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/users/dto/create-user.dto.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';

export class CreateUserDto {
  @ApiProperty({ example: 'johndoe' }) <i class="conum" data-value="1"></i><b>(1)</b>
  readonly _id: string; <i class="conum" data-value="2"></i><b>(2)</b>

  @ApiProperty({ example: 'John Doe' })
  readonly name: string;

  @ApiProperty({ example: 'johndoe@gmail.com' })
  readonly email: string;

  @ApiProperty({ example: 'Spain' })
  readonly country: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para definir una propiedad para la documentación en Swagger OpenAPI</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición de campo</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En Swagger UI, al desplegar el endpoint <code>POST /users</code> el ejemplo muestra los valores configurados con el decorador <code>@ApiProperty</code> de Swagger OpenAPI. También aparecen como plantilla si probásemos a introducir un usuario. Aún no probaremos a insertar el usuario porque está sin implementar el servicio. Recordamos que la implementación actual del servicio es la que ha generado el CLI de NestJS y se limita a mostrar que el servicio ha sido llamado. Hay que cambiar su implementación para que interactúe con la base de datos.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/dto-usuario.png" alt="dto usuario">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-servicio-2"><a class="anchor" href="#trueimplementación-del-servicio-2"></a>5.4. Implementación del servicio</h3>
<div class="paragraph">
<p>Partimos del código generado por el CLI de NestJS para el servicio. Además de dar la implementación de la interacción con la base de datos mediante Mongoose habrá que:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hacer que los métodos sean <code>async</code> ya que los métodos de acceso a la base de datos son asíncronos y devuelven promesas.</p>
</li>
<li>
<p>Configurar el tipo devuelto por los métodos.</p>
</li>
<li>
<p>Cambiar el parámetro <code>id</code> de <code>number</code> a <code>string</code> para que pueda tratar con el <code>_id</code> hexadecimal de MongoDB.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Recordamos que el CLI de NestJS genera el código de los métodos del servicio pensando en que la clave es de tipo numérico. Hay que cambiar el tipo del argumento <code>id</code> en los métodos <code>findOne</code>, <code>update</code> y <code>remove</code> a <code>string</code> para que sea válido para el <code>_id</code> de 24 caracteres hexadecimales de MongoDB.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tal y como hemos comentado anteriormente, los métodos que usaremos de Mongoose serán</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>create()</code> para la inserción de un documento.</p>
</li>
<li>
<p><code>find()</code> para recuperar todo.</p>
</li>
<li>
<p><code>findOne()</code> para recuperar un documento.</p>
</li>
<li>
<p><code>findOneAndUpdate()</code> para la actualización de un documento.</p>
</li>
<li>
<p><code>remove()</code> para la eliminación de un documento.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/users/users.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { User, UserDocument } from './schemas/user.schema';

@Injectable()
export class UsersService {
  constructor( <i class="conum" data-value="1"></i><b>(1)</b>
    @InjectModel(User.name) private readonly userModel: Model&lt;UserDocument&gt;, <i class="conum" data-value="2"></i><b>(2)</b>
  ) {}

  async create(createUserDto: CreateUserDto): Promise&lt;User&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
    return this.userModel.create(createUserDto); <i class="conum" data-value="4"></i><b>(4)</b>
  }

  async findAll(): Promise&lt;User[]&gt; { <i class="conum" data-value="5"></i><b>(5)</b>
    return this.userModel.find().exec();
  }

  async findOne(id: string): Promise&lt;User&gt; { <i class="conum" data-value="6"></i><b>(6)</b>
    return this.userModel.findOne({ _id: id }).exec(); <i class="conum" data-value="7"></i><b>(7)</b>
  }

  async update(id: string, updateUserDto: UpdateUserDto) { <i class="conum" data-value="8"></i><b>(8)</b>
    return this.userModel.findOneAndUpdate({ _id: id }, updateUserDto, { <i class="conum" data-value="9"></i><b>(9)</b>
      new: true, <i class="conum" data-value="10"></i><b>(10)</b>
    });
  }

  async remove(id: string) { <i class="conum" data-value="11"></i><b>(11)</b>
    return this.userModel.findByIdAndRemove({ _id: id }).exec(); <i class="conum" data-value="12"></i><b>(12)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadir un constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definir un modelo para usuarios mediante inyección de dependencias</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cambiar a <code>async</code> y que devuelva <code>Promise&lt;User&gt;</code> con el usuario creado</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamada al método de creación de documentos</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Cambiar a <code>async</code> y que devuelva <code>Promise&lt;User[]&gt;</code> con la lista de usuarios</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Cambio del tipo <code>id</code> a <code>string</code> para adaptarlo al <code>_id</code> de MongoDB, cambiar a <code>async</code> y que devuelva <code>Promise&lt;User&gt;</code> con el usuario buscado</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Llamada al método de búsqueda de un documento por <code>id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Cambio del tipo <code>id</code> a <code>string</code> para adaptarlo al <code>_id</code> de MongoDB, cambiar a <code>async</code> y que devuelva <code>Promise&lt;User&gt;</code> con el usuario modificado</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Llamada al método de actualización de documentos por <code>id</code> pasándole el JSON con las modificaciones</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Opción para que devuelva el objeto modificado</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Cambio del tipo <code>id</code> a <code>string</code> para adaptarlo al <code>_id</code> de MongoDB y cambiar a <code>async</code></td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Llamada al método de eliminación de documentos por <code>id</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>De forma predeterminada, el método <code>findOneAndUpdate</code> devuelve el objeto original, no el modificado. Para que devuelva el objeto ya modificado hay que pasar al método la opción de <code>{new: true}</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemodificación-del-controlador-2"><a class="anchor" href="#truemodificación-del-controlador-2"></a>5.5. Modificación del controlador</h3>
<div class="paragraph">
<p>Tal y como hemos comentado anteriormente, en el controlador hay que hacer pocos cambios respecto al código generado por el CLI de NestJS. Sólo haremos cambios para</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No convertir a <code>number</code> el valor del <code>id</code> recibido como parámetro en la URL para las operaciones de buscar uno, modificar y eliminar.</p>
</li>
<li>
<p>Añadir decoradores de Swagger OpenAPI.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/users/users.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from '@nestjs/common';
import { UsersService } from './users.service';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { ApiTags } from '@nestjs/swagger'; <i class="conum" data-value="1"></i><b>(1)</b>

@Controller('users')
@ApiTags('user') <i class="conum" data-value="2"></i><b>(2)</b>

export class UsersController {
  constructor(private readonly userService: UsersService) {}

  @Post()
  async create(@Body() createUserDto: CreateUserDto) {
    return this.userService.create(createUserDto);
  }

  @Get()
  async findAll() {
    return this.userService.findAll();
  }

  @Get(':id')
  async findOne(@Param('id') id: string) {
    return this.userService.findOne(id); <i class="conum" data-value="3"></i><b>(3)</b>
  }

  @Patch(':id')
  async update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
    return this.userService.update(id, updateUserDto); <i class="conum" data-value="4"></i><b>(4)</b>
  }

  @Delete(':id')
  async remove(@Param('id') id: string) {
    return this.userService.remove(id); <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador de OpenAPI para agrupar los endpoints en Swagger UI</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Agrupar los endpoints para una etiqueta en Swagger UI</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pasar al servicio el <code>id</code> como cadena porque el <code>_id</code> en MongoDB son cadenas hexadecimales</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Pasar al servicio el <code>id</code> como cadena porque el <code>_id</code> en MongoDB son cadenas hexadecimales</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pasar al servicio el <code>id</code> como cadena porque el <code>_id</code> en MongoDB son cadenas hexadecimales</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La configuración del decorador <code>@ApiTags('user')</code> ha creado una categoría <code>user</code> en Swagger UI para los usuarios.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/categoria-user.png" alt="categoria user">
</div>
</div>
</div>
<div class="sect2">
<h3 id="truefiltrado-de-resultados-mediante-parámetros-en-la-url-2"><a class="anchor" href="#truefiltrado-de-resultados-mediante-parámetros-en-la-url-2"></a>5.6. Filtrado de resultados mediante parámetros en la URL</h3>
<div class="paragraph">
<p>Tal y como hemos comentado anteriormente, podemos añadir a nuestras peticiones de recuperación de datos opciones de filtrado. Lo haremos mediante parámetros de consulta en la URL (p.e. <code>?country=Spain</code>). Para ello, añadiremos un objeto <code>Request</code> de <code>Express</code> al método <code>findAll</code> para permitir el uso de parámetros en la URL para el filtrado de resultados.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/users/users.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  Req
} from '@nestjs/common';
import { UsersService } from './users.service';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { ApiTags } from '@nestjs/swagger';
import { Request } from 'express'; <i class="conum" data-value="1"></i><b>(1)</b>

@Controller('users')
@ApiTags('user')

export class UsersController {
  constructor(private readonly userService: UsersService) {}

  @Post()
  async create(@Body() createUserDto: CreateUserDto) {
    return this.userService.create(createUserDto);
  }

  @Get()
  async findAll(@Req() request: Request) { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.userService.findAll(request); <i class="conum" data-value="3"></i><b>(3)</b>
  }

  @Get(':id')
  async findOne(@Param('id') id: string) {
    return this.userService.findOne(id);
  }

  @Patch(':id')
  async update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
    return this.userService.update(id, updateUserDto);
  }

  @Delete(':id')
  async remove(@Param('id') id: string) {
    return this.userService.remove(id);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de objetos <code>Request</code> de <code>Express</code> en el controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incluir un parámetro con un objeto <code>Request</code> para acceder a los parámetros de la consulta en la URL</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Incluir el objeto <code>Request</code> en la llamada al servicio</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora introducimos los cambios en el servicio para permitir acceder a los parámetros introducidos en la URL para filtrar y cambiamos la implementación del método <code>findAll</code> para que use la búsqueda con filtros.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/users/users.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateUserDto } from './dto/create-user.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { User, UserDocument } from './schemas/user.schema';
import { Request } from 'express'; <i class="conum" data-value="1"></i><b>(1)</b>

@Injectable()
export class UsersService {
  constructor(
    @InjectModel(User.name) private readonly userModel: Model&lt;UserDocument&gt;,
  ) {}

  async create(createUserDto: CreateUserDto): Promise&lt;User&gt; {
    return this.userModel.create(createUserDto);
  }

  async findAll(request: Request): Promise&lt;User[]&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    return this.userModel
      .find(request.query) <i class="conum" data-value="3"></i><b>(3)</b>
      .setOptions({ sanitizeFilter: true }) <i class="conum" data-value="4"></i><b>(4)</b>
      .exec();
  }

  async findOne(id: string): Promise&lt;User&gt; {
    return this.userModel.findOne({ _id: id }).exec();
  }

  async update(id: string, updateUserDto: UpdateUserDto): Promise&lt;User&gt; {
    return this.userModel.findOneAndUpdate({ _id: id }, updateUserDto, {
      new: true,
    });
  }

  async remove(id: string) {
    return this.userModel.findByIdAndRemove({ _id: id }).exec();
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadir la dependencia con <code>Request</code> de <code>Express</code> para acceder a los parámetros de la consulta de una <code>request</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Añadir un parámetro <code>Request</code> para acceder a los parámetros de la consulta pasados en la URL</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Llamada al método de búsqueda de documentos pasándole los parámetros de la consulta</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configuración para evitar la inyección de código malicioso</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>request.query</code> devuelve una lista clave-valor con cada uno de los campos de filtrado y su valor correspondiente introducidos en la URL.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueprueba-de-los-endpoints-2"><a class="anchor" href="#trueprueba-de-los-endpoints-2"></a>5.7. Prueba de los endpoints</h3>
<div class="paragraph">
<p>Probamos el endpoint <code>POST /users</code> con los valores del ejemplo</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/user-post.png" alt="user post">
</div>
</div>
<div class="paragraph">
<p>El resultado devuelto será similar a este, en el que se muestran los datos guardados en la base de datos junto al <code>_id</code> generado por MongoDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "_id": "johndoe",
  "name": "John Doe",
  "email": "johndoe@gmail.com",
  "country": "Spain",
  "__v": 0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Insertaremos también otro usuario a modo de prueba con estos valores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "_id": "marysmith",
  "name": "Mary Smith",
  "email": "marysmith@gmail.com",
  "country": "France"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la inserción podemos probar que se recuperan correctamente los usuarios con el endpoint <code>GET /users</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/all-users.png" alt="all users">
</div>
</div>
<div class="paragraph">
<p>Para probar el endpoint que devuelve un usuario concreto, desplegaremos en Swagger UI el endpoint <code>GET /users/{:id}</code>, pulsamemos <code>Try it out</code> para probar el endpoint e introduciremos el <code>_id</code> del usuario creado (<code>johndoe</code>). Tras pulsar <code>Execute</code> vemos que se recupera correctamente el usuario.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/user-findone.png" alt="user findone">
</div>
</div>
<div class="paragraph">
<p>Para probar el filtrado comprobaremos con una condición de filtrado para usuarios de España. Para ello, en la URL introduciremos la condición de esta forma</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="code" class="language-code hljs">$ http://localhost:3000/users?country=spain</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para hacer esta prueba necesitaremos un cliente HTTP o bien introducir la URL en un navegador.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/user-query-params.png" alt="user query params">
</div>
</div>
<div class="paragraph">
<p>Para hacer una modificación se pasará un JSON en el cuerpo de la petición con los cambios a realizar. Por ejemplo, para cambiar el país a Italia pasaríamos este JSON en el cuerpo de la petición al endpoint <code>PATCH /users/{id}</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "country": "Italy"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si lanzamos la petición con el <code>_id</code> del usuario a modificar, los cambios se almacenarán en la base de datos y nos devolverá los datos actualizados con país a Italia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "_id": "johndoe",
  "name": "John Doe",
  "email": "johndoe@gmail.com",
  "country": "Italy",
  "__v": 0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para eliminar un usuario basta con usar el endpoint <code>DELETE /users/{id}</code> con el <code>_id</code> del usuario a eliminar.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truerechazo-de-peticiones-con-_id-inválido"><a class="anchor" href="#truerechazo-de-peticiones-con-_id-inválido"></a>6. Rechazo de peticiones con <code>_id</code> inválido</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Si en colecciones con <code>_id</code> de tipo <code>ObjectID</code> de MongoDB realizamos operaciones de búsqueda, actualización o eliminación con un <code>id</code> con formato inválido se producira un error. Si hacemos la prueba con el endpoint <code>GET /books/{id}</code> y le pasamos un <code>id</code> que no tenga el formato hexadecimal de 24 caracteres del los identificadores de MongoDB (p.e. <code>1</code>), obtendremos un error.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/error-id.png" alt="error id">
</div>
</div>
<div class="paragraph">
<p>Una solución para este problema es usar un <em>pipe</em> de NestJS para que compruebe si el identificador pasado en la URL es correcto. Si no es correcto interceptará el error y lo informará. Si es correcto, el <em>pipe</em> devuelve el valor de entrada tal cual.</p>
</div>
<div class="paragraph">
<p>El <em>pipe</em> se apoya en el método <code>isObjectIdOrHexString</code> del paquete <code>mongoose</code>. que devuelve <code>true</code> si es un identificador MongoDB válido o <code>false</code> en caso contrario.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra el código del <em>pipe</em>, que hemos colocado en la carpeta <code>utilities</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>utilities/parse-object-id-pipe.pipe.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { PipeTransform, Injectable, BadRequestException } from '@nestjs/common';
import mongoose from 'mongoose';

@Injectable()
export class ParseObjectIdPipe
  implements PipeTransform&lt;any, mongoose.Types.ObjectId&gt;
{
  transform(value: any): mongoose.Types.ObjectId {
    const validObjectId: boolean = mongoose.isObjectIdOrHexString(value); <i class="conum" data-value="1"></i><b>(1)</b>
    if (!validObjectId) {
      throw new BadRequestException('Invalid ObjectId'); <i class="conum" data-value="2"></i><b>(2)</b>
    }
    return value; <i class="conum" data-value="3"></i><b>(3)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Determinar si el identificador es válido para MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lanzar una excepción si el identificador no es válido</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Devolver el valor si el identificador es válido
Uso del pipe en los controladores</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El <em>pipe</em> <code>ParseObjectIdPipe</code> definido se usará en los controladores que tengan endpoints que acepten identificadores MongoDB. El <em>pipe</em> se colocará después del parámetro <code>id</code> leído en la URL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs"> @Get(':id')
  findOne(@Param('id', ParseObjectIdPipe) id: string) { <i class="conum" data-value="1"></i><b>(1)</b>
    return this.booksService.findOne(id);
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso del <em>pipe</em> tras leer el <code>id</code> de la URL.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora volvemos a lanzar la petición, ya no provocará un error en la aplicación y nos informará del error adecuadamente.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/invalid-objectid.png" alt="invalid objectid">
</div>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Req } from '@nestjs/common';
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
import { Request } from 'express';
import { BooksService } from './books.service';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { ParseObjectIdPipe } from '../utilities/parse-object-id-pipe.pipe';

@Controller('books')
@ApiTags('book')
export class BooksController {
  constructor(private readonly booksService: BooksService) {}

  @Post()
  create(@Body() createBookDto: CreateBookDto) {
    return this.booksService.create(createBookDto);
  }

  @Get()
  findAll(@Req() request: Request) {
    return this.booksService.findAll(request);
  }

  @Get(':id')
  findOne(@Param('id', ParseObjectIdPipe) id: string) { <i class="conum" data-value="1"></i><b>(1)</b>
    return this.booksService.findOne(id);
  }

  @Patch(':id')
  update(
    @Param('id', ParseObjectIdPipe) id: string, <i class="conum" data-value="2"></i><b>(2)</b>
    @Body() updateBookDto: UpdateBookDto,
  ) {
    return this.booksService.update(id, updateBookDto);
  }

  @Delete(':id')
  remove(@Param('id', ParseObjectIdPipe) id: string) { <i class="conum" data-value="3"></i><b>(3)</b>
    return this.booksService.remove(id);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de <code>ParseObjectIdPipe</code> para la búsqueda de un libro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uso de <code>ParseObjectIdPipe</code> para la modificación de un libro</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Uso de <code>ParseObjectIdPipe</code> para la eliminación de un libro</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueincorporación-de-comentarios"><a class="anchor" href="#trueincorporación-de-comentarios"></a>7. Incorporación de comentarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cuando creamos el esquema para los libros, el campo <code>keywords</code> fue definido como un array. En una base de datos relacional habríamos definido una tabla aparte para guardar esa lista de valores. Sin embargo, en una base de datos como MongoDB las técnicas de diseño son diferentes y ese tipo de campos multivaluados se guardan directamente en un array.</p>
</div>
<div class="paragraph">
<p>El campo <code>keywords</code> fue definido como un array de cadenas en el esquema de los libros.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Schema()
export class Book {
  ...

  @Prop([String]) <i class="conum" data-value="1"></i><b>(1)</b>
  keywords: string[]; <i class="conum" data-value="2"></i><b>(2)</b>
}

...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Array de <code>String</code> MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Palabras clave como un array de cadenas</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para tipos no primitivos (como arrays, documentos o una combinación de ellos) hay que añadir en <code>@Prop()</code> el tipo de datos que se va usar.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación vamos a modificar el esquema de los libros para añadir un nuevo campo para los comentarios. De acuerdo con el esquema de <a href="#trueintroducción">Introducción</a> los comentarios también son un campo multivaluado. Sin embargo, a diferencia de las palabras clave, no son un array de un tipo primitivo. Los comentarios son un array de documentos. En tal caso, crearemos un esquema para ellos.</p>
</div>
<div class="sect2">
<h3 id="truecreación-del-esquema-3"><a class="anchor" href="#truecreación-del-esquema-3"></a>7.1. Creación del esquema</h3>
<div class="paragraph">
<p>Inicialmente, y de acuerdo con el diagrama de <a href="#trueintroducción">Introducción</a>, exceptuando el identificador, los campos de los comentarios son los siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code> como título del comentario.</p>
</li>
<li>
<p><code>stars</code> como valoración en forma de estrellas que tiene el comentario.</p>
</li>
<li>
<p><code>comment</code> como descripción del comentario.</p>
</li>
<li>
<p><code>username</code> como autor del comentario.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En este esquema prestamos también atención a que los autores de los comentarios son los usuarios que tenemos definidos en el esquema <code>User</code>.  Esto lo implementaremos mediante referencias en Mongoose.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/schemas/comment.schema.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">import { Schema, Prop, SchemaFactory } from '@nestjs/mongoose';
import { ApiProperty } from '@nestjs/swagger';
import { Document } from 'mongoose';
import { User } from '../../users/schemas/user.schema';
import mongoose from 'mongoose';

export type CommentDocument = Comment &amp; Document;

@Schema()
export class Comment {
  @Prop()
  title: string;

  @Prop()
  stars: number;

  @Prop()
  comment: string;

  @Prop({ type: mongoose.Schema.Types.String, ref: 'User' }) <i class="conum" data-value="1"></i><b>(1)</b>
  username: User; <i class="conum" data-value="2"></i><b>(2)</b>
}

export const CommentSchema = SchemaFactory.createForClass(Comment);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tipo como una referencia a los usuarios en los que la clave es un <code>String</code>, no un <code>ObjectId</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creador del comentario de tipo <code>User</code></td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tipos de las referencias</div>
<div class="paragraph">
<p>Una referencia introduce una relación entre un campo y un esquema Mongoose. La referencia se configura en el decorador <code>@Prop()</code>. Hay que tener en cuenta dos cuestiones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Con <code>ref</code> definimos el tipo de datos del campo que se está definiendo. Lo hacemos indicando el esquema de destino.</p>
</li>
<li>
<p><code>type</code> es el tipo de datos Mongoose con el que enlaza la propiedad que se está definiendo. En el ejemplo de los usuarios, como el <code>_id</code> lo configuramos para que fuera el nombre de usuario y éste lo definimos como tipo cadena, la referencia del destino será a un tipo <code>mongoose.Schema.Types.String</code>. Si el campo referenciado fuese un identificador hexadecimal MongoDB, el tipo de datos sería <code>mongoose.Schema.Types.ObjectId</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueincorporación-de-los-comentarios-al-esquema-de-los-libros"><a class="anchor" href="#trueincorporación-de-los-comentarios-al-esquema-de-los-libros"></a>7.2. Incorporación de los comentarios al esquema de los libros</h3>
<div class="paragraph">
<p>Una vez definido el esquema de los comentarios podemos modificar el esquema de los libros para añadirle un nuevo campo para los comentarios. Su tipo de datos será un array de comentarios.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/schemas/book.schema.ts</code></div>
<div class="content">
<pre>import { Schema, Prop, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose';
import { CommentSchema } from './comment.schema';

export type BookDocument = Book &amp; Document;

@Schema()
export class Book {
  @Prop()
  genre: string;

  @Prop()
  description: string;

  @Prop()
  author: string;

  @Prop()
  pages: number;

  @Prop()
  image_url: string;

  @Prop([String])
  keywords: string[];

  @Prop([CommentSchema]) <i class="conum" data-value="1"></i><b>(1)</b>
  comments: Comment[]; <i class="conum" data-value="2"></i><b>(2)</b>
}

export const BookSchema = SchemaFactory.createForClass(Book);</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuración del tipo porque no es un tipo básico</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tipo de los comentarios</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Como el tipo de datos de los comentarios no es un tipo primitivo, hay que indicar su tipo en el decorador <code>@Prop</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Al guardar los cambios se modificarán los documentos almacenados en la colección <code>books</code> y les habrá añadido un campo <code>comments</code> cuyo tipo es un array de comentarios.</p>
</div>
<div class="paragraph">
<p>Si probamos cualquiera de los endpoints de recuperación de libros veremos que ahora los libros tienen la lista de comentarios. A continuación se muestra lo que devolvería el endpoint <code>GET /users</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">[
  {
    "_id": "62594f8ddae1eebf6c6c209c",
    "genre": "Web Development",
    "description": "JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...",
    "author": "Jay Bell",
    "pages": 350,
    "image_url": "https://m.media-amazon.com/images/I/41fveBeDWmL._SY346_.jpg",
    "keywords": [
      "NestJS",
      "REST API"
    ],
    "__v": 0,
    "comments": [] <i class="conum" data-value="1"></i><b>(1)</b>
  }
]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Comentarios como un array</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Los agregados en una base de datos NoSQL</div>
<div class="paragraph">
<p>La definición de un esquema para los comentarios no supone la creación de una nueva colección. Para definir una colección a partir de un esquema en Mongoose hay que crear un <em>modelo</em>. En el tutorial hemos creado dos modelos al inyectarlos como dependencia en los servicios creados para los libros y los usuarios. Crear un esquema para los comentarios simplemente define un tipo de documento que queda disponible para definir campos en un esquema Mongoose.</p>
</div>
<div class="paragraph">
<p>La idea de incorporación de datos anidados choca bastante inicialmente si se tiene una visión relacional profunda. La creación de estas estructuras complejas de arrays, subdocumentos y cualquier combinación de ellos se corresponde con el concepto de <em>agregado</em> de las bases de datos NoSQL. En una base de datos relacional habríamos segregado los comentarios a una tabla aparte debido a la relación <code>1:M</code> que hay entre los libros y los comentarios. Sin embargo, el criterio de diseño en una base de datos NoSQL es que si los datos se van a recuperar juntos, se deben almacenar también juntos.</p>
</div>
<div class="paragraph">
<p>El planteamiento de los <em>agregados</em> reduce enormemente la complejidad de los esquemas de la base de datos y aumenta la velocidad de las consultas, ya que se reducen las operaciones de <em>join</em> porque los datos relacionados están almacenados junto a los datos que los referencian. Por tanto, es muy importante conocer a priori los tipos de consultas que vamos a tener porque condicionarán e influirán en el diseño de la base de datos para definir los agregados.</p>
</div>
<div class="paragraph">
<p>Para una visión panorámica sobre las bases de datos NoSQL, consulta <a href="https://www.thoughtworks.com/insights/blog/nosql-databases-overview">NoSQL Databases: An Overview
</a>. Si no conoces las bases de datos NoSQL, tras su lectura cambiará tu forma de ver las bases de datos.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto-3"><a class="anchor" href="#truecreación-del-dto-3"></a>7.3. Creación del DTO</h3>
<div class="paragraph">
<p>El DTO define la estructura de un objeto que se pasa en el cuerpo de una petición HTTP. Inicialmente, y de acuerdo con el diagrama de <a href="#trueintroducción">Introducción</a>, para un comentario tendremos los mismos campos que para el esquema definido anteriormente. Cuando se guarden los comentarios, MongoDB les asignará un <code>_id</code> porque no se ha definido ningún <code>_id</code> específico en el esquema de los comentarios, pero esto es cosa de MongoDB. Desde el punto de vista del DTO, los datos que nos interesan son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>title</code> como título del comentario.</p>
</li>
<li>
<p><code>stars</code> como valoración en forma de estrellas que tiene el comentario.</p>
</li>
<li>
<p><code>comment</code> como descripción del comentario.</p>
</li>
<li>
<p><code>username</code> como autor del comentario.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/dto/create-comment.dto.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
import { User } from '../../users/schemas/user.schema';

export class CreateCommentDto {
  @ApiProperty({ example: 'Esperaba más' })
  readonly title: string;

  @ApiProperty({
    example: 3,
  })
  readonly stars: number;

  @ApiProperty({
    example:
      'Nisi officia fugiat id nulla laboris ex. Sit laboris culpa occaecat occaecat aliquip dolor non excepteur reprehenderit.',
  })
  readonly comment: string;

  @ApiProperty({ example: 'johndoe' })
  readonly username: User;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-método-de-creación-de-comentarios"><a class="anchor" href="#trueimplementación-del-método-de-creación-de-comentarios"></a>7.4. Implementación del método de creación de comentarios</h3>
<div class="paragraph">
<p>A continuación hay que modificar el servicio de comentarios para implementar un nuevo método que permita añadir comentarios a un libro. El nuevo método recibirá dos argumentos: el <code>id</code> del libro al que hay que añadir el comentario y el objeto con el comentario. Su implementación consistirá en recuperar el libro, añadir el comentario al array de comentarios del libro y guardar el libro.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { InjectModel } from '@nestjs/mongoose';
import { Book, BookDocument } from './schemas/book.schema';
import { Model } from 'mongoose';
import { Request } from 'express';

@Injectable()
export class BooksService {
  constructor(
    @InjectModel(Book.name) private readonly bookModel: Model&lt;BookDocument&gt;,
  ) {}

  async create(createBookDto: CreateBookDto): Promise&lt;Book&gt; {
    return this.bookModel.create(createBookDto);
  }

  async findAll(request: Request): Promise&lt;Book[]&gt; {
    return this.bookModel
      .find(request.query)
      .setOptions({ sanitizeFilter: true })
      .exec();
  }

  async findOne(id: string): Promise&lt;Book&gt; {
    return this.bookModel.findOne({ _id: id }).exec();
  }

  async update(id: string, updateBookDto: UpdateBookDto): Promise&lt;Book&gt; {
    return this.bookModel.findOneAndUpdate({ _id: id }, updateBookDto, {
      new: true,
    });
  }

  async remove(id: string) {
    return this.bookModel.findByIdAndRemove({ _id: id }).exec();
  }

  async addComment(id: string, comment: any) { <i class="conum" data-value="1"></i><b>(1)</b>
    let book: BookDocument = await this.bookModel.findById(id); <i class="conum" data-value="2"></i><b>(2)</b>
    book.comments.push(comment); <i class="conum" data-value="3"></i><b>(3)</b>
    book.save(); <i class="conum" data-value="4"></i><b>(4)</b>
    return book;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Método para añadir un comentario a un libro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Recuperar el libro por su identificador</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Añadir el comentario al array de comentarios</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Guardar el libro</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemodificación-del-controlador-3"><a class="anchor" href="#truemodificación-del-controlador-3"></a>7.5. Modificación del controlador</h3>
<div class="paragraph">
<p>Ahora vamos a añadir una nueva ruta al controlador de los libros que realice una operación <code>POST</code>. La ruta será <code>/books/{id}/comment</code> y hace referencia a que al libro <code>{id}</code> se le va a crear un comentario. El comentario se le pasará en el cuerpo de la petición de acuerdo con el DTO de creación de comentarios definido anteriormente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Req } from '@nestjs/common';
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
} from '@nestjs/common';
import { ApiTags } from '@nestjs/swagger';
import { Request } from 'express';
import { BooksService } from './books.service';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { ParseObjectIdPipe } from '../utilities/parse-object-id-pipe.pipe';
import { CreateCommentDto } from './dto/create-comment.dto';

@Controller('books')
@ApiTags('book')
export class BooksController {
  constructor(private readonly booksService: BooksService) {}

  @Post()
  create(@Body() createBookDto: CreateBookDto) {
    return this.booksService.create(createBookDto);
  }

  @Get()
  findAll(@Req() request: Request) {
    return this.booksService.findAll(request);
  }

  @Get(':id')
  findOne(@Param('id', ParseObjectIdPipe) id: string) {
    return this.booksService.findOne(id);
  }

  @Patch(':id')
  update(
    @Param('id', ParseObjectIdPipe) id: string,
    @Body() updateBookDto: UpdateBookDto,
  ) {
    return this.booksService.update(id, updateBookDto);
  }

  @Delete(':id')
  remove(@Param('id', ParseObjectIdPipe) id: string) {
    return this.booksService.remove(id);
  }

  @Post(':id/comment') <i class="conum" data-value="1"></i><b>(1)</b>
  async addComment(
    @Param('id', ParseObjectIdPipe) id: string, <i class="conum" data-value="2"></i><b>(2)</b>
    @Body() comment: CreateCommentDto, <i class="conum" data-value="3"></i><b>(3)</b>
  ) {
    return this.booksService.addComment(id, comment); <i class="conum" data-value="4"></i><b>(4)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ruta para añadir los comentarios</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Captura del parámetro y paso por el <em>pipe</em> de comprobación de identificadores de MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Paso del comentario en el cuerpo de la petición</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamada al método de incorporación de comentarios</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueprueba-del-endpoint"><a class="anchor" href="#trueprueba-del-endpoint"></a>7.6. Prueba del endpoint</h3>
<div class="paragraph">
<p>Ya sólo nos falta ver en acción lo que hemos desarrollado para la incorporación de comentarios a los libros. Si desplegamos el nuevo endpoint de la API para añadir libros, crearemos un nuevo comentario pasándole el identificador del libro y dejaremos el comentario predeterminado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/añadir-comentario-predeterminado.png" alt="añadir comentario predeterminado">
</div>
</div>
<div class="paragraph">
<p>Tras añadirlo, la respuesta del servidor sería el libro con el comentario añadido incorporando el usuario que ha realizado el comentario.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "_id": "62594f8ddae1eebf6c6c209c",
  "genre": "Web Development",
  "description": "JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...",
  "author": "Jay Bell",
  "pages": 350,
  "image_url": "https://m.media-amazon.com/images/I/41fveBeDWmL._SY346_.jpg",
  "keywords": [
    "NestJS",
    "REST API"
  ],
  "__v": 1,
  "comments": [
    { <i class="conum" data-value="1"></i><b>(1)</b>
      "title": "Esperaba más",
      "stars": 3,
      "comment": "Nisi officia fugiat id nulla laboris ex. Sit laboris culpa occaecat occaecat aliquip dolor non excepteur reprehenderit.",
      "username": "johndoe", <i class="conum" data-value="2"></i><b>(2)</b>
      "_id": "625bade7c73a12ec6c5c9c16"
    }
  ]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Comentario añadido</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Identificador del usuario que ha realizado el comentario</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Añadiremos un segundo comentario al mismo libro a cargo de <code>marysmith</code> con el contenido siguiente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "title": "Me encantó",
  "stars": 5,
  "comment": "Non consequat laborum pariatur et tempor fugiat excepteur. Incididunt minim voluptate nostrud Lorem ullamco consectetur sint veniam amet non aliqua proident. Cillum reprehenderit veniam nulla ex eiusmod id sit tempor. Consectetur nostrud Lorem duis culpa sit incididunt aliqua.",
  "username": "marysmith",
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/añadir-segundo-comentario.png" alt="añadir segundo comentario">
</div>
</div>
<div class="paragraph">
<p>El servidor devolvería ahora el libro con los dos comentarios añadidos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "_id": "62594f8ddae1eebf6c6c209c",
  "genre": "Web Development",
  "description": "JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...",
  "author": "Jay Bell",
  "pages": 350,
  "image_url": "https://m.media-amazon.com/images/I/41fveBeDWmL._SY346_.jpg",
  "keywords": [
    "NestJS",
    "REST API"
  ],
  "__v": 1,
  "comments": [
    { <i class="conum" data-value="1"></i><b>(1)</b>
      "title": "Esperaba más",
      "stars": 3,
      "comment": "Nisi officia fugiat id nulla laboris ex. Sit laboris culpa occaecat occaecat aliquip dolor non excepteur reprehenderit.",
      "username": "johndoe",
      "_id": "625bade7c73a12ec6c5c9c16"
    },
    { <i class="conum" data-value="2"></i><b>(2)</b>
      "title": "Me encantó",
      "stars": 5,
      "comment": "Non consequat laborum pariatur et tempor fugiat excepteur. Incididunt minim voluptate nostrud Lorem ullamco consectetur sint veniam amet non aliqua proident. Cillum reprehenderit veniam nulla ex eiusmod id sit tempor. Consectetur nostrud Lorem duis culpa sit incididunt aliqua.",
      "username": "marysmith",
      "_id": "625baedcc73a12ec6c5c9c19"
    }
  ]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Primer comentario</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Segundo comentario</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si consultamos los libros con cualquiera de los dos endpoints disponibles, ahora cada libro incorporá sus comentarios.</p>
</div>
</div>
<div class="sect2">
<h3 id="trueincoporación-de-los-datos-relacionados"><a class="anchor" href="#trueincoporación-de-los-datos-relacionados"></a>7.7. Incoporación de los datos relacionados</h3>
<div class="paragraph">
<p>La familia de los métodos <code>find</code> de Mongoose ofrece la posibilidad de añadir los datos relacionados a un resultado. Esto nos permite incorporar a los comentarios los datos completos de los usuarios en las consultas (p.e. país, nombre completo, &#8230;&#8203;). Recordemos que en cada comentario sólo se guardaba el <code>username</code> de un usuario (su identificador). El resto de los datos de los usuarios están en la colección <code>users</code>.</p>
</div>
<div class="paragraph">
<p>El método <code>populate</code> añadido a una operación de la famila <code>find</code> permite esa <em>hidratación</em> con datos relacionados. Al método <code>populate</code> se le pasa el campo que se quiere enriquecer. De forma predeterminada, se poblará siguiendo la relación definida en el esquema. No obstante, es posible poblar un campo con cualquier conjunto de datos.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra cómo quedaría finalmente el servicio de los libros al que se ha incorporado el método <code>populate</code> del campo <code>comments.username</code> a los dos métodos <code>find</code> implementados.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>src/books/books.service.ts</code></div>
<div class="content">
<pre>import { Injectable } from '@nestjs/common';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { InjectModel } from '@nestjs/mongoose';
import { Book, BookDocument } from './schemas/book.schema';
import { Model } from 'mongoose';
import { Request } from 'express';

@Injectable()
export class BooksService {
  constructor(
    @InjectModel(Book.name) private readonly bookModel: Model&lt;BookDocument&gt;,
  ) {}

  async create(createBookDto: CreateBookDto): Promise&lt;Book&gt; {
    return this.bookModel.create(createBookDto);
  }

  async findAll(request: Request): Promise&lt;Book[]&gt; {
    return this.bookModel
      .find(request.query)
      .populate({ path: 'comments.username' }) <i class="conum" data-value="1"></i><b>(1)</b>
      .setOptions({ sanitizeFilter: true })
      .exec();
  }

  async findOne(id: string): Promise&lt;Book&gt; {
    return this.bookModel
      .findOne({ _id: id })
      .populate({ path: 'comments.username' }) <i class="conum" data-value="2"></i><b>(2)</b>
      .exec();
  }

  async update(id: string, updateBookDto: UpdateBookDto): Promise&lt;Book&gt; {
    return this.bookModel.findOneAndUpdate({ _id: id }, updateBookDto, {
      new: true,
    });
  }

  async remove(id: string) {
    return this.bookModel.findByIdAndRemove({ _id: id }).exec();
  }

  async addComment(id: string, comment: any) {
    let book: BookDocument = await this.bookModel.findById(id);
    book.comments.push(comment);
    book.save();
    return book;
  }
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incorporación de datos de usuario</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incorporación de datos de usuario</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueanexo-i-configuración-de-mongodb-local-con-docker-compose"><a class="anchor" href="#trueanexo-i-configuración-de-mongodb-local-con-docker-compose"></a>Anexo I. Configuración de MongoDB local con Docker Compose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para trabajar localmente con MongoDB necesitamos una base de datos a la que conectarnos. Para no tener que complicarnos con instalaciones y no acoplar el desarrollo a nuestro equipo, en este tutorial utilizaremos una instalación local de MongoDB con Docker Compose. Trabajaremos con una base de datos denominada <code>tutorial</code> que guarda los datos en un directorio <code>mongo-data</code> respecto al directorio en el que esté el archivo <code>docker-compose.yml</code>. Esta base de datos debe coincidir con la que se use a la hora de establecer la conexión. En el tutorial hemos realizado la conexión en <code>app.module.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>docker-compose.yml</code></div>
<div class="content">
<pre>version: "3"

services:
  mongodb:
    container_name: mongodb
    image: mongo:latest
    environment:
      - MONGODB_DATABASE="tutorial"
    ports:
      - 27017:27017
    volumes:
      - ./mongo-data:/data/db</pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-04-17 15:04:08 +0200
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>